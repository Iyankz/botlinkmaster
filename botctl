#!/bin/bash

# BotLinkMaster v4.0 - Service Management Script
# Easy interface for managing the systemd service

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

SERVICE_NAME="botlinkmaster"

print_usage() {
    cat << EOF
BotLinkMaster Service Manager

Usage: $0 <command>

Commands:
    start       Start the bot service
    stop        Stop the bot service
    restart     Restart the bot service
    status      Show service status
    enable      Enable auto-start on boot
    disable     Disable auto-start
    logs        View service logs (live)
    logs-all    View all service logs
    install     Install/setup the service
    uninstall   Remove the service

Examples:
    $0 start        # Start the bot
    $0 logs         # View logs (Ctrl+C to exit)
    $0 status       # Check if running

EOF
}

check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}✗${NC} This command requires root privileges"
        echo "Run: sudo $0 $1"
        exit 1
    fi
}

case "${1:-}" in
    start)
        check_root start
        echo "Starting BotLinkMaster..."
        systemctl start $SERVICE_NAME
        sleep 2
        systemctl status $SERVICE_NAME --no-pager
        ;;
    
    stop)
        check_root stop
        echo "Stopping BotLinkMaster..."
        systemctl stop $SERVICE_NAME
        echo -e "${GREEN}✓${NC} Service stopped"
        ;;
    
    restart)
        check_root restart
        echo "Restarting BotLinkMaster..."
        systemctl restart $SERVICE_NAME
        sleep 2
        systemctl status $SERVICE_NAME --no-pager
        ;;
    
    status)
        systemctl status $SERVICE_NAME --no-pager
        echo ""
        echo "Quick commands:"
        echo "  View logs: sudo $0 logs"
        echo "  Restart:   sudo $0 restart"
        ;;
    
    enable)
        check_root enable
        echo "Enabling auto-start on boot..."
        systemctl enable $SERVICE_NAME
        echo -e "${GREEN}✓${NC} Service will start automatically on boot"
        ;;
    
    disable)
        check_root disable
        echo "Disabling auto-start..."
        systemctl disable $SERVICE_NAME
        echo -e "${YELLOW}⚠${NC} Service will NOT start automatically on boot"
        ;;
    
    logs)
        echo "Viewing live logs (Ctrl+C to exit)..."
        echo ""
        journalctl -u $SERVICE_NAME -f
        ;;
    
    logs-all)
        echo "Viewing all logs..."
        echo ""
        journalctl -u $SERVICE_NAME --no-pager
        ;;
    
    install)
        check_root install
        if [ -f "./setup-service.sh" ]; then
            ./setup-service.sh
        else
            echo -e "${RED}✗${NC} setup-service.sh not found"
            exit 1
        fi
        ;;
    
    uninstall)
        check_root uninstall
        echo "Uninstalling BotLinkMaster service..."
        
        # Stop service
        if systemctl is-active --quiet $SERVICE_NAME; then
            systemctl stop $SERVICE_NAME
            echo -e "${GREEN}✓${NC} Service stopped"
        fi
        
        # Disable service
        if systemctl is-enabled --quiet $SERVICE_NAME; then
            systemctl disable $SERVICE_NAME
            echo -e "${GREEN}✓${NC} Service disabled"
        fi
        
        # Remove service file
        if [ -f "/etc/systemd/system/$SERVICE_NAME.service" ]; then
            rm /etc/systemd/system/$SERVICE_NAME.service
            systemctl daemon-reload
            echo -e "${GREEN}✓${NC} Service file removed"
        fi
        
        echo ""
        echo -e "${GREEN}✓${NC} Service uninstalled successfully"
        echo ""
        echo "Note: Application files are still in place"
        echo "To remove completely, delete the installation directory"
        ;;
    
    *)
        print_usage
        exit 1
        ;;
esac
